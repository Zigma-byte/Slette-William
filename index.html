<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slette William</title>
<link rel="icon" type="image/x-icon" href="./lw.png">
<style>
body {
  margin:0;
  background:#f7f7f7;
  font-family:sans-serif;
  overflow:hidden;
}
.settings {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: white;
  border-bottom: 2px solid black;
  padding: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  z-index: 10;
  box-sizing: border-box;
}
.settings label {
  display:flex;
  flex-direction: column;
  font-size:14px;
}
input[type=range]{ width: 150px; }
canvas {
  display:block;
  position:absolute;
  top:120px;
  left:0;
  width:100%;
  height:calc(100vh - 120px);
}
#pauseMenu{
  position: fixed;
  top:120px;
  left:0;
  width:100%;
  height: calc(100vh - 120px);
  background: rgba(0,0,0,0.7);
  color:white;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:20;
}
#pauseMenu div{text-align:center;}
#pauseMenu button{margin:10px; padding:10px 20px; font-size:16px; cursor:pointer;}
</style>
</head>
<body>

<div class="settings">
  <label>
    Cactus Spawn Frequency (ms)
    <input type="range" min="400" max="2000" id="spawnFreq">
    <span id="spawnFreqVal"></span>
  </label>
  <label>
    William's Speed
    <input type="range" min="2" max="20" id="dinoSpeed">
    <span id="dinoSpeedVal"></span>
  </label>
  <label>
    Jump Power
    <input type="range" min="6" max="20" id="jumpPower">
    <span id="jumpPowerVal"></span>
  </label>
  <label>
    Gravity
    <input type="range" min="0.2" max="5" step="0.1" id="gravity">
    <span id="gravityVal"></span>
  </label>
  <label>
    Passive Score Rate (+points/sec)
    <input type="range" min="0" max="10" step="0.05" id="scoreRate">
    <span id="scoreRateVal"></span>
  </label>
  <label>
    Hard Jump Chance (%)
    <input type="range" min="0" max="100" id="hardJump">
    <span id="hardJumpVal"></span>
  </label>
  <label>
    Character Hitbox Height
    <input type="range" min="0" max="100" id="hitHeight">
    <span id="hitHeightVal"></span>
  </label>
  <button id="resetSettings">Reset Settings</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="pauseMenu">
  <div>
    <h2>Game Paused</h2>
    <button onclick="resumeGame()">Resume</button>
    <button onclick="restartGame()">Restart</button>
  </div>
</div>

<script>
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight-120;

const dinoImg=new Image();
const cacImg=new Image();
const jetImg=new Image();
dinoImg.src="./lw.png";
cacImg.src="./cac.png";
jetImg.src="./fw.png";

const passSound=new Audio("./sound.mp3");
const milestoneSound=new Audio("./over.mp3");
const background1=new Audio("./back.mp3");
const background2=new Audio("./back2.mp3");
const background3=new Audio("./end.mp3");
background1.volume=0.4;
background2.volume=0.4;

// Settings
const settings = {
  spawnFreq: document.getElementById("spawnFreq"),
  dinoSpeed: document.getElementById("dinoSpeed"),
  jumpPower: document.getElementById("jumpPower"),
  gravity: document.getElementById("gravity"),
  scoreRate: document.getElementById("scoreRate"),
  hardJump: document.getElementById("hardJump"),
  hitHeight: document.getElementById("hitHeight")
};
const displayValues = {
  spawnFreqVal: document.getElementById("spawnFreqVal"),
  dinoSpeedVal: document.getElementById("dinoSpeedVal"),
  jumpPowerVal: document.getElementById("jumpPowerVal"),
  gravityVal: document.getElementById("gravityVal"),
  scoreRateVal: document.getElementById("scoreRateVal"),
  hardJumpVal: document.getElementById("hardJumpVal"),
  hitHeightVal: document.getElementById("hitHeightVal")
};

const defaults={spawnFreq:1000,dinoSpeed:6,jumpPower:12,gravity:0.6,scoreRate:0.2,hardJump:12.5,hitHeight:20};
for(let key in settings){
  settings[key].value=localStorage.getItem(key)||defaults[key];
  displayValues[key+"Val"].textContent=settings[key].value;
  settings[key].addEventListener("input",()=>{
    displayValues[key+"Val"].textContent=settings[key].value;
    localStorage.setItem(key,settings[key].value);
    if(key==="hitHeight") dino.hitHeight=parseFloat(settings.hitHeight.value);
  });
}

document.getElementById("resetSettings").addEventListener("click",()=>{
  for(let key in defaults){
    localStorage.setItem(key, defaults[key]);
  }
  location.reload();
});

let dino={
  x:50,
  y:-10,
  width:60,
  height:70,
  hitHeight:parseFloat(settings.hitHeight.value),
  dy:0,
  isJumping:false
};
let cactuses=[];
let jets=[];
let fallingCactuses=[];
let score=0;
let highScore=localStorage.getItem("highScore")||0;
let normalHighScore=localStorage.getItem("normalHighScore")||0;
let moddedHighScore=localStorage.getItem("moddedHighScore")||0;
let gameOver=false;
let paused=false;
const ground=canvas.height-80;
let cactusTimer=null;
let jetsUnlocked = false;
let pendingBounce = null;
let lastMilestone = 0;

function isDefaultSettings(){
  for(let key in defaults){
    let current=parseFloat(settings[key].value);
    let def=defaults[key];
    if(Math.abs(current-def)>0.001) return false;
  }
  return true;
}

function drawDino(){ctx.drawImage(dinoImg,dino.x,dino.y,dino.width,dino.height);}
function drawCactus(c){ctx.drawImage(cacImg,c.x,c.y,c.width,c.height);}

function spawnCactus(){
  if(paused||gameOver) return;
  let width=Math.floor(Math.random()*20)+20;
  let height=Math.floor(Math.random()*40)+40;
  let gap=Math.floor(Math.random()*200)+400;

  if(Math.random()*100<parseFloat(settings.hardJump.value)){
    let first={x:canvas.width+gap,y:ground+(60-height),width:width,height:height};
    let second={x:first.x+first.width+Math.floor(Math.random()*10)+10,y:ground+(60-height),width:width,height:height};
    cactuses.push(first,second);
  }else{
    cactuses.push({x:canvas.width+gap,y:ground+(60-height),width:width,height:height});
  }

  cactusTimer=setTimeout(spawnCactus,Math.random()*700+parseFloat(settings.spawnFreq.value));
}

// Jet spawning
function spawnJet() {
  if (paused || gameOver) return;
  jets.push({
    x: -100,
    y: Math.random() * 90 + 20,
    width: 100,
    height: 60,
    speed: 4,
    dropCooldown: Math.floor(Math.random() * 80) + 30,
    spawnTime: Date.now()
  });
  setTimeout(spawnJet, Math.random() * 5000 + 5000);
}

// Jet + falling cactuses update
function updateJets() {
  for (let i = 0; i < jets.length; i++) {
    let jet = jets[i];
    jet.x += jet.speed;

    if (Date.now() - jet.spawnTime > 450) {
      jet.dropCooldown--;
      if (jet.dropCooldown <= 0) {
        let dx = -0.2 - Math.random() * 5;
        fallingCactuses.push({
            x: jet.x + jet.width / 2 - 10,
            y: jet.y + jet.height,
            width: 20,
            height: 40,
            dy: 5,
            dx: dx
        });
        jet.dropCooldown = Math.floor(Math.random() * 60) + 25;
      }
    }

    if (jet.x > canvas.width + 100) {
      jets.splice(i, 1);
      i--;
    } else {
      ctx.drawImage(jetImg, jet.x, jet.y, jet.width, jet.height);
    }
  }

  // falling cactuses
  for (let i = 0; i < fallingCactuses.length; i++) {
    let fc = fallingCactuses[i];
    fc.y += fc.dy;
    fc.x += fc.dx;
    ctx.drawImage(cacImg, fc.x, fc.y, fc.width, fc.height);

    if (dino.hitHeight > 0) {
      let collides = dino.x < fc.x + fc.width &&
                     dino.x + dino.width > fc.x &&
                     dino.y < fc.y + fc.height &&
                     dino.y + dino.hitHeight > fc.y;

      if (collides) {
        if (!pendingBounce) {
          pendingBounce = { time: Date.now(), cactus: fc };
        }
      }
    }

    if(fc.y > canvas.height + 50 || fc.x + fc.width < 0){
        fallingCactuses.splice(i,1);
        i--;
    }
  }
}

// Handle game over + highscores
function handleGameOver(){
  gameOver = true;

  if(score > highScore){
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }
  if(isDefaultSettings() && score > normalHighScore){
    normalHighScore = score;
    localStorage.setItem("normalHighScore", normalHighScore);
  } else if(!isDefaultSettings() && score > moddedHighScore){
    moddedHighScore = score;
    localStorage.setItem("moddedHighScore", moddedHighScore);
  }

  alert("Game Over! Score: " + Math.floor(score));
  document.location.reload();
}

// Game loop
function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!paused && !gameOver){
    dino.y+=dino.dy;
    if(dino.y+dino.height<canvas.height) dino.dy+=parseFloat(settings.gravity.value);
    if(dino.y>=ground){ dino.y=ground; dino.dy=0; dino.isJumping=false; }

    for(let i=0;i<cactuses.length;i++){
      let c=cactuses[i];
      c.x-=parseFloat(settings.dinoSpeed.value);
      drawCactus(c);

      if(dino.hitHeight > 0 &&
         dino.x<c.x+c.width&&dino.x+dino.width>c.x&&
         dino.y<c.y+c.height&&dino.y+dino.hitHeight>c.y){
        handleGameOver();
      }

      if(c.x+c.width<0){cactuses.splice(i,1);passSound.currentTime=0;passSound.play();score++;i--;}
    }

    drawDino();

    if (!jetsUnlocked && score > 20) {
      jetsUnlocked = true;
      spawnJet();
    }

    if(jetsUnlocked) updateJets();

    // Pending bounce check
    if (pendingBounce && Date.now() - pendingBounce.time > 1000) {
      handleGameOver();
    }

    ctx.fillStyle="black";
    ctx.font="20px Arial";
    ctx.fillText("Score: "+Math.floor(score),canvas.width-250,30);
    ctx.fillText("High Score: "+Math.floor(highScore),canvas.width-250,55);
    ctx.fillText("Normal High: "+Math.floor(normalHighScore),canvas.width-250,80);
    ctx.fillText("Modded High: "+Math.floor(moddedHighScore),canvas.width-250,105);

    if(score >= 300){
      triggerSecretEnding();
    }
  }

  requestAnimationFrame(update);
}

// Passive score
setInterval(()=>{
  if(!paused&&!gameOver){
    score += parseFloat(settings.scoreRate.value)*0.5;
    let floored = Math.floor(score);
    if (floored % 10 === 0 && floored !== lastMilestone) {
      milestoneSound.currentTime = 0;
      milestoneSound.play();
      lastMilestone = floored;
    }
  }
},500);

function jump(){
  if (pendingBounce) {
    dino.dy = -parseFloat(settings.jumpPower.value);
    dino.isJumping = true;
    pendingBounce = null;
  } else if(!dino.isJumping){
    dino.dy=-parseFloat(settings.jumpPower.value);
    dino.isJumping=true;
  }
}

function togglePause(){
  paused=!paused;
  document.getElementById("pauseMenu").style.display=paused?"flex":"none";
}
function resumeGame(){ paused=false; document.getElementById("pauseMenu").style.display="none"; }
function restartGame(){
  clearTimeout(cactusTimer);
  score=0; gameOver=false; paused=false;
  cactuses=[]; jets=[]; fallingCactuses=[]; jetsUnlocked=false;
  dino.y=-10; dino.dy=0; dino.isJumping=false;
  pendingBounce=null;
  lastMilestone=0;
  document.getElementById("pauseMenu").style.display="none";
  spawnCactus();
}

// Controls
document.addEventListener("keydown",(e)=>{
  if(e.code==="Space"){jump(); if(!musicPlaying) playRandomTrack();}
  if(e.code==="KeyP"){togglePause();}
});
canvas.addEventListener("click", ()=>{ jump(); if(!musicPlaying) playRandomTrack(); });
canvas.addEventListener("touchstart", (e)=>{ e.preventDefault(); jump(); if(!musicPlaying) playRandomTrack(); }, {passive:false});

dinoImg.onload=()=>{update(); spawnCactus();}
window.addEventListener("resize",()=>{canvas.height=window.innerHeight-120;});

// Music
let musicPlaying=false;
function playRandomTrack(){
  musicPlaying=true;
  let pick=Math.random()<0.5 ? background1 : background2;
  background1.pause(); background2.pause();
  background1.currentTime=0; background2.currentTime=0;
  pick.play();
  pick.onended=()=>{musicPlaying=false; playRandomTrack();}
}

// SECRET ENDING
function triggerSecretEnding(){
  gameOver = true;
  paused = true;
  clearTimeout(cactusTimer);

  let overlay=document.createElement("div");
  overlay.style.position="fixed";
  overlay.style.top="0";
  overlay.style.left="0";
  overlay.style.width="100%";
  overlay.style.height="100%";
  overlay.style.background="black";
  overlay.style.display="flex";
  overlay.style.justifyContent="center";
  overlay.style.alignItems="center";
  overlay.style.flexDirection="column";
  overlay.style.zIndex="9999";
  overlay.style.color="white";
  overlay.style.overflow="hidden";
  document.body.appendChild(overlay);

  // Cinematic black bars
  let topBar=document.createElement("div");
  let bottomBar=document.createElement("div");
  [topBar,bottomBar].forEach(bar=>{
    bar.style.position="absolute";
    bar.style.width="100%";
    bar.style.height="120px";
    bar.style.background="black";
    bar.style.left="0";
    bar.style.zIndex="10000";
  });
  topBar.style.top="0"; bottomBar.style.bottom="0";
  overlay.appendChild(topBar); overlay.appendChild(bottomBar);

  // William sprite
  let william=document.createElement("img");
  william.src=dinoImg.src;
  william.style.width="160px";
  william.style.height="180px";
  william.style.position="relative";
  william.style.marginBottom="40px";
  william.style.opacity="0";
  william.style.animation="fadeIn 3s forwards, zoomIn 8s forwards";
  overlay.appendChild(william);

  // Multiple jets fly across
  for(let i=0;i<3;i++){
    let jet=document.createElement("img");
    jet.src=jetImg.src;
    jet.style.width="220px";
    jet.style.height="140px";
    jet.style.position="absolute";
    jet.style.top=(100+i*150)+"px";
    jet.style.animation=`jetAttack ${4+i}s forwards ${i*1.5}s`;
    overlay.appendChild(jet);
  }

  // Styles
  let style=document.createElement("style");
  style.innerHTML=`
    @keyframes jetAttack {
      0% { transform: translateX(600px) scale(1); opacity:1; }
      50% { transform: translateX(0) scale(1.1); opacity:1; }
      100% { transform: translateX(-800px) scale(0.8); opacity:0; }
    }
    @keyframes zoomIn {
      from { transform: scale(1); }
      to { transform: scale(1.5) translateY(-50px); }
    }
    @keyframes floatUp {
      0% { transform: translateY(0); opacity:1; }
      100% { transform: translateY(-400px) scale(1.2); opacity:1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  `;
  document.head.appendChild(style);

  // Sequence
  setTimeout(()=>{
    william.style.animation="floatUp 6s ease-out forwards";
    background1.pause();
    background2.pause();
    background3.play();

    setTimeout(()=>{
      let msg=document.createElement("div");
      msg.innerHTML="<center> WILLIAM ESCAPED! </center><br><span style='font-size:22px'><center>THE END..</center><br><center>Thanks for playing!!</center></span>";
      msg.style.fontSize="44px";
      msg.style.marginTop="30px";
      msg.style.opacity="0";
      msg.style.animation="fadeIn 5s forwards";
      overlay.appendChild(msg);

      // Add restart button at the end
      let restartBtn = document.createElement("button");
      restartBtn.textContent = "Restart Game";
      restartBtn.style.padding="15px 30px";
      restartBtn.style.fontSize="22px";
      restartBtn.style.marginTop="40px";
      restartBtn.style.cursor="pointer";
      restartBtn.onclick = ()=>{location.reload();}
      overlay.appendChild(restartBtn);
    },3000);
  },6000);
}
</script>
</body>
</html>
